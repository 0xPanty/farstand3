# 🗂️ API 版本管理指南

## 📋 当前版本说明

### 版本历史

| 版本 | 文件名 | 说明 | 状态 |
|------|--------|------|------|
| **v3 优化版** | `api/farcaster.ts` | 智能降级 + 缓存 + 优化 | ✅ **当前使用** |
| v2 原始版 | `api/farcaster.ts.old` | 原始版本（无降级） | 📦 已备份 |
| v1 优化源 | `api/farcaster-optimized.ts` | 优化版源文件 | 📄 保留 |

---

## 🔄 自动切换机制

### 当前部署的版本如何工作

```
用户访问
  ↓
/api/farcaster?fid=XXX
  ↓
检查缓存（5分钟）
  ↓
尝试调用 Neynar API
  ├─ ✅ 成功（额度足够）
  │   ↓
  │   返回真实数据 ✅
  │   - Power: 基于真实 followers
  │   - Speed: 基于真实 casts
  │   - 等等...
  │
  └─ ❌ 失败（429/超时）
      ↓
      使用降级算法
      ↓
      返回计算数据 ⚡
      - Power: 基于 FID seed
      - Speed: 基于 FID seed
      - 等等...
```

### ✅ 1月9日后会发生什么

**完全自动！**

```
2025年1月9日 0:00
  ↓
Neynar 额度重置为 0%
  ↓
API 调用成功率恢复 100%
  ↓
系统自动切换回真实数据
  ↓
✅ 无需任何手动操作！
```

---

## 🔧 如果需要手动管理（通常不需要）

### 场景 1: 想查看原始版本（无降级）

```powershell
# 查看原始版本代码
Get-Content api\farcaster.ts.old
```

### 场景 2: 想恢复到原始版本

```powershell
# ⚠️ 注意：这会移除降级保护！

# 1. 备份当前优化版
Copy-Item api\farcaster.ts api\farcaster-with-fallback.ts

# 2. 恢复原始版本
Copy-Item api\farcaster.ts.old api\farcaster.ts -Force

# 3. 提交
git add api/farcaster.ts
git commit -m "恢复原始版本（无降级方案）"
git push
```

### 场景 3: 想重新应用优化版

```powershell
# 1. 从优化源恢复
Copy-Item api\farcaster-optimized.ts api\farcaster.ts -Force

# 2. 提交
git add api/farcaster.ts
git commit -m "重新应用优化版本"
git push
```

---

## 📊 版本对比

### v2 原始版（farcaster.ts.old）

**特点**：
- ❌ 无缓存
- ❌ 无降级方案
- ❌ limit=150（高消耗）
- ❌ 调用 Hub API（慢）
- ❌ 超额时直接报错

**适用场景**：
- Neynar 额度充足时
- 需要最准确的实时数据
- 不在乎 API 消耗

### v3 优化版（当前使用）

**特点**：
- ✅ 5分钟缓存
- ✅ 智能降级（Neynar失败时）
- ✅ limit=25（节省 83% 调用）
- ✅ 移除 Hub API
- ✅ 超额时返回计算数据

**适用场景**：
- ✅ **现在立即使用**（超额期间）
- ✅ 长期使用（节省额度）
- ✅ 任何时候（自动适应）

---

## 🎯 推荐策略

### ✅ 推荐：永久使用优化版

**理由**：
1. **自动适应**：额度正常时用真实数据，超额时降级
2. **节省 90% API 调用**：以后不会再超额
3. **5分钟缓存**：提升响应速度
4. **更好的用户体验**：即使超额也能用

### ❌ 不推荐：恢复原始版

**原因**：
1. 2月份会再次超额
2. 超额时用户体验差（白屏/报错）
3. 消耗额度高

---

## 📝 文件清单

当前目录下的相关文件：

```
api/
├── farcaster.ts              ← 当前使用（v3 优化版）
├── farcaster.ts.old          ← 备份（v2 原始版）
├── farcaster-optimized.ts    ← 优化源文件
├── get-gallery.ts           ← Gallery API（当前）
├── get-gallery.ts.old       ← Gallery 备份
└── get-gallery-optimized.ts ← Gallery 优化源
```

---

## 🔍 如何检查当前使用的版本

### 方法 1: 查看代码特征

```powershell
# 检查是否有缓存机制
Select-String -Path "api\farcaster.ts" -Pattern "cache"

# 检查是否有降级方案
Select-String -Path "api\farcaster.ts" -Pattern "generateFallbackStats"
```

如果两个都找到 → v3 优化版 ✅
如果都找不到 → v2 原始版

### 方法 2: 查看 Git 日志

```powershell
git log --oneline -5
```

应该看到：
```
5a5d7a5 🔥 修复数值面板全E问题 - 添加智能降级方案
```

---

## 📅 时间线

```
现在（12月16日）
  ↓
  部署 v3 优化版 ✅
  - Neynar 超额 → 显示计算数据
  - 用户能正常使用
  ↓
继续使用（12月16日 - 1月9日）
  - 系统自动使用降级数据
  - API 调用量大幅减少
  ↓
1月9日凌晨
  ↓
  Neynar 额度自动重置
  ↓
1月9日起
  - 系统自动切换回真实数据 ✅
  - 由于优化，每月只用 15% 额度
  - 再也不会超额 🎉
  ↓
长期稳定运行
  - 无需任何手动操作
  - 永远不会再超额
```

---

## 🚨 紧急恢复步骤

如果优化版出现问题（通常不会），快速恢复：

```powershell
# 30秒紧急恢复
cd "C:\Users\Administrator\Desktop\jojo-stand-maker (9)"
Copy-Item api\farcaster.ts.old api\farcaster.ts -Force
git add api/farcaster.ts
git commit -m "紧急回滚"
git push
```

---

## 💡 最佳实践

### ✅ DO（推荐）

1. **保持使用优化版**
2. 监控 Neynar 使用量（https://dev.neynar.com/billing）
3. 定期查看 Vercel 日志
4. 1月9日后确认自动切换成功

### ❌ DON'T（不推荐）

1. ❌ 不要恢复原始版本
2. ❌ 不要删除备份文件
3. ❌ 不要手动修改降级逻辑
4. ❌ 不要增加 limit 参数

---

## 📞 问题排查

### Q: 如何确认1月9日后恢复真实数据？

**A**: 查看 Vercel 函数日志：
```
✅ 如果看到：
  "📡 Fetching data for FID XXX"
  "✅ Query success"
  
→ 说明正在使用真实数据

❌ 如果看到：
  "⚠️ Neynar API failed"
  "🔧 Using fallback stats"
  
→ 说明仍在降级模式（检查额度是否重置）
```

### Q: 降级数据和真实数据如何区分？

**A**: 查看 Details 字段：
```
降级模式：
  Power: "Calculated: 460 followers"
  Speed: "Calculated: 920 casts"

真实模式：
  Power: "Score: 95%"
  Speed: "5234 Casts"
```

---

**记住：当前优化版已经是最佳方案，无需任何手动操作！**
