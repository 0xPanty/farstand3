# 🔧 快速修复方案

## 问题核心
**用户看不到数值面板的根本原因：前端直接调用 Neynar API 遇到 CORS 跨域问题**

## ✅ 立即修复（3 步）

### Step 1: 修改 `services/farcasterService.ts`

将整个文件替换为：

```typescript
import { FarcasterProfile, StandStats, StandStatRawValues } from "../types";

// 🔥 关键修改：不再直接调用 Neynar，改为调用自己的 API
export const fetchFarcasterUser = async (fid: number): Promise<any> => {
  try {
    console.log('🔍 开始获取用户数据, FID:', fid);
    
    // ✅ 调用自己的 API 端点（避免 CORS）
    const response = await fetch(`/api/farcaster?fid=${fid}`);
    
    if (!response.ok) {
      throw new Error(`API 返回错误: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('✅ API 返回数据:', data);
    
    return data; // 返回整个数据对象（包含 profile, stats, details）
  } catch (error) {
    console.error('❌ 获取用户数据失败:', error);
    return null;
  }
};

// 🔥 不再需要这个函数，API 已经返回计算好的 stats
export const calculateFarcasterStats = async (profile: FarcasterProfile) => {
  // 如果传入的是完整数据，直接返回
  if ((profile as any).stats && (profile as any).details) {
    return {
      stats: (profile as any).stats,
      details: (profile as any).details
    };
  }
  
  // 否则再调用一次 API
  console.warn('⚠️ 需要重新获取 stats');
  const data = await fetchFarcasterUser(profile.fid);
  
  if (data && data.stats && data.details) {
    return {
      stats: data.stats,
      details: data.details
    };
  }
  
  // 最后的兜底方案
  return {
    stats: {
      power: 'E' as const,
      speed: 'E' as const,
      range: 'E' as const,
      durability: 'E' as const,
      precision: 'E' as const,
      potential: 'E' as const
    },
    details: {
      power: '无数据',
      speed: '无数据',
      range: '无数据',
      durability: '无数据',
      precision: '无数据',
      potential: '无数据'
    }
  };
};
```

### Step 2: 修改 `App.tsx` 的 useEffect

找到 `useEffect` 部分（大约第 870 行），替换为：

```typescript
useEffect(() => {
  const init = async () => {
    try {
      console.log('🚀 开始初始化 SDK...');
      await sdk.actions.ready();
      console.log('✅ SDK 就绪');
      
      const context = await sdk.context;
      console.log('📦 Context:', context);
      
      if (context?.user?.fid) {
        const fid = context.user.fid;
        console.log('👤 用户 FID:', fid);
        
        // 快速显示基本信息
        const quickUser: FarcasterProfile = {
          fid: fid,
          username: context.user.username || '',
          displayName: context.user.displayName || context.user.username || '',
          pfpUrl: context.user.pfpUrl || '',
          bio: '',
          followerCount: 0,
          followingCount: 0,
          castCount: 0,
          likesReceived: 0,
          recastsReceived: 0,
          repliesReceived: 0,
          verifications: [],
          powerBadge: false
        };
        setFarcasterUser(quickUser);
        
        // 🔥 关键修改：调用新的 API 方法
        console.log('📊 开始获取完整数据...');
        const fullData = await fetchFarcasterUser(fid);
        console.log('📦 完整数据:', fullData);
        
        if (fullData) {
          // 设置用户资料
          if (fullData.profile) {
            console.log('✅ 设置用户资料');
            setFarcasterUser(fullData.profile);
          }
          
          // 设置统计数据
          if (fullData.stats && fullData.details) {
            console.log('✅ 设置统计数据:', fullData.stats);
            setCalculatedData({
              stats: fullData.stats,
              details: fullData.details
            });
          } else {
            console.warn('⚠️ API 未返回 stats/details');
          }
        } else {
          console.error('❌ 获取完整数据失败');
        }
      } else {
        console.log('ℹ️ 无 Frame Context，使用 Demo 用户');
        // Demo 用户逻辑
        const demoFid = 3;
        const demoData = await fetchFarcasterUser(demoFid);
        
        if (demoData) {
          if (demoData.profile) {
            setFarcasterUser(demoData.profile);
          }
          if (demoData.stats && demoData.details) {
            setCalculatedData({
              stats: demoData.stats,
              details: demoData.details
            });
          }
        }
      }
    } catch (error) {
      console.error('❌ 初始化错误:', error);
      
      // 错误兜底：加载 demo 用户
      try {
        const demoData = await fetchFarcasterUser(3);
        if (demoData) {
          if (demoData.profile) setFarcasterUser(demoData.profile);
          if (demoData.stats && demoData.details) {
            setCalculatedData({
              stats: demoData.stats,
              details: demoData.details
            });
          }
        }
      } catch (e) {
        console.error('❌ Demo 用户加载也失败:', e);
      }
    }
  };
  
  init();
}, []);
```

### Step 3: 确认 API 返回格式

检查 `api/farcaster.ts` 的返回（应该已经是正确的）：

```typescript
return res.status(200).json({
  profile: profile,
  stats: calculatedData.stats,
  details: calculatedData.details
});
```

## 🧪 测试步骤

### 1. 本地测试

```bash
# 重启开发服务器
npm run dev
```

### 2. 打开浏览器控制台

访问 http://localhost:5173，打开控制台（F12），你应该看到：

```
🚀 开始初始化 SDK...
✅ SDK 就绪
📦 Context: { user: { fid: XXX, ... } }
👤 用户 FID: XXX
📊 开始获取完整数据...
🔍 开始获取用户数据, FID: XXX
✅ API 返回数据: { profile: {...}, stats: {...}, details: {...} }
📦 完整数据: { profile: {...}, stats: {...}, details: {...} }
✅ 设置用户资料
✅ 设置统计数据: { power: "A", speed: "B", ... }
```

### 3. 检查 Network 标签

应该看到：
- ✅ `/api/farcaster?fid=XXX` 请求成功（状态码 200）
- ✅ 响应包含 `profile`, `stats`, `details` 三个字段
- ❌ **不应该**看到直接向 `api.neynar.com` 的请求（那会被 CORS 阻止）

## 🎯 为什么这样修复？

### 问题原因
```
浏览器 → 直接请求 Neynar API → ❌ CORS 错误
```

### 修复后
```
浏览器 → 你的 API (/api/farcaster) → Neynar API → ✅ 成功
         ↑ 同域请求，无 CORS 问题    ↑ 服务端请求，无 CORS 限制
```

## 📊 预期结果

修复后，用户应该能看到：

1. ✅ Printer 屏幕显示用户信息
2. ✅ Stats Radar 图表正确渲染
3. ✅ 6 个 Stat Circles 显示 A/B/C/D/E 等级
4. ✅ 详细数值（Followers, Txns, Casts 等）显示

## 🚨 如果还是不行

### 检查 API 端点是否工作

在浏览器中直接访问：
```
https://你的域名/api/farcaster?fid=3
```

应该返回 JSON 数据。如果返回错误，问题在后端。

### 检查环境变量

确认 Vercel 环境变量设置了：
```
NEYNAR_API_KEY=你的KEY
```

### 查看 Vercel 日志

在 Vercel 控制台查看函数日志，看是否有错误。

---

**立即执行这 3 步修复，然后告诉我控制台输出什么！**
