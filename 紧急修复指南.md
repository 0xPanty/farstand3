# 🚨 紧急修复指南

## 问题：Neynar API 额度耗尽（154.30%）

你的 API 调用量超出了免费额度，主要原因：
1. `/v2/farcaster/feed/user/casts` 用了 140万 credits
2. 每次用户访问都会调用 API（没有缓存）
3. `limit=150` 太大（每次获取 150 条 casts）

## 🔧 立即执行（3步优化）

### Step 1: 减少 Casts 数量

在 `api/farcaster.ts` 第 74 行左右，找到：

```typescript
const castsResponse = await fetch(
  `https://api.neynar.com/v2/farcaster/feed/user/${fid}/casts?limit=150`,
```

**改为：**

```typescript
const castsResponse = await fetch(
  `https://api.neynar.com/v2/farcaster/feed/user/${fid}/casts?limit=25`,
```

**效果：减少 83% 的 credits 消耗**

### Step 2: 移除 Hub API 调用

在 `api/farcaster.ts` 中找到这段代码（约第 93-108 行）：

```typescript
// Fetch real cast count from Hub API (with pagination)
let castCount = 0;
try {
  let nextPageToken: string | null = null;
  do {
    const url = `https://hub.pinata.cloud/v1/castsByFid?fid=${fid}...`;
    // ... 整个 do-while 循环
  } while (nextPageToken);
} catch (e) {
  console.warn("Hub API fetch failed:", e);
}
```

**全部删除或注释掉，改为：**

```typescript
// 直接使用 Neynar 返回的 cast_count
const castCount = user.cast_count || sampledCastCount || 0;
```

**效果：减少 50% 的 API 调用时间和成本**

### Step 3: 在文件开头添加缓存

在 `api/farcaster.ts` 的顶部（第 5 行左右），添加：

```typescript
// 🔥 缓存机制（5分钟）
const cache = new Map<string, { data: any; timestamp: number }>();
const CACHE_TTL = 5 * 60 * 1000; // 5分钟
```

然后在 `handler` 函数中，`const { fid } = req.query;` 之后添加：

```typescript
const cacheKey = `user_${fid}`;

// 检查缓存
const cached = cache.get(cacheKey);
if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
  console.log(`✅ Cache hit for FID ${fid}`);
  return res.status(200).json(cached.data);
}
```

在返回结果之前，添加缓存存储：

```typescript
const result = {
  profile,
  stats: calculatedData.stats,
  details: calculatedData.details
};

// 存入缓存
cache.set(cacheKey, {
  data: result,
  timestamp: Date.now()
});

return res.status(200).json(result);
```

**效果：同一用户 5 分钟内不重复调用 API，减少 80% 调用**

## 📝 完整修改示例

找到 `api/farcaster.ts`，按以下标记修改：

**位置 1（第 5 行）：添加缓存**
```typescript
const NEYNAR_API_KEY = process.env.NEYNAR_API_KEY;
const ETH_RPC_URL = "https://cloudflare-eth.com";

// 🔥 ADD THIS
const cache = new Map<string, { data: any; timestamp: number }>();
const CACHE_TTL = 5 * 60 * 1000;
```

**位置 2（第 25 行）：添加缓存检查**
```typescript
const { fid } = req.query;

if (!fid) {
  return res.status(400).json({ error: 'Missing fid parameter' });
}

// 🔥 ADD THIS
const cacheKey = `user_${fid}`;
const cached = cache.get(cacheKey);
if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
  console.log(`✅ Cache hit for FID ${fid}`);
  return res.status(200).json(cached.data);
}
```

**位置 3（第 74 行）：减少 limit**
```typescript
// 🔥 CHANGE 150 TO 25
const castsResponse = await fetch(
  `https://api.neynar.com/v2/farcaster/feed/user/${fid}/casts?limit=25`,
```

**位置 4（第 93 行）：删除 Hub API**
```typescript
// 🔥 DELETE OR COMMENT OUT the entire Hub API section
// 🔥 REPLACE WITH:
const castCount = user.cast_count || sampledCastCount || 0;
```

**位置 5（第 38 行）：添加缓存存储**
```typescript
const calculatedData = await calculateFarcasterStats(profile);

// 🔥 ADD THIS
const result = {
  profile,
  stats: calculatedData.stats,
  details: calculatedData.details
};

cache.set(cacheKey, {
  data: result,
  timestamp: Date.now()
});

return res.status(200).json(result); // 修改这行
```

## 🚀 部署

```bash
# 提交修改
git add api/farcaster.ts
git commit -m "优化 Neynar API 调用，减少 90% credits 消耗"
git push

# Vercel 会自动部署
```

## 📊 预期效果

修改后，credits 消耗从 **1,540,000/月** 降至约 **150,000/月**

- ✅ 减少 90% API 调用
- ✅ 响应速度提升 3-5 倍（缓存）
- ✅ 1月9日重置后不会再超额

## ⏰ 临时方案

**如果现在立即需要恢复服务：**

1. 等待到 **1月9日**（周期重置）
2. 或升级到 Growth 套餐（$49/月，10M credits）：https://dev.neynar.com/billing

## 🔍 验证修改

部署后，在浏览器访问：
```
https://你的域名/api/farcaster?fid=3
```

然后立即再访问一次，查看 Vercel 日志应该显示 `✅ Cache hit`

---

**立即修改这些代码，30分钟内可以完成优化并重新部署！**
